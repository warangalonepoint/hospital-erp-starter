<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bookings / Tokens</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=23"/>
  <style>
    .section { margin:12px; }
    .tint { border-radius:16px; padding:16px; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.06); }
    .tint-blue   { background: color-mix(in srgb, #3b82f6 12%, var(--card-bg)); }
    .tint-purple { background: color-mix(in srgb, #8b5cf6 12%, var(--card-bg)); }
    .grid-2 { display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:720px){ .grid-2 { grid-template-columns:1fr 1fr; } }
    .field { display:grid; gap:6px; }
    .label { font-size:12px; color:var(--muted); }
    .input, select { height:44px; border-radius:12px; border:1px solid rgba(0,0,0,.12); padding:0 12px; background:var(--card-bg); }
    .textarea { min-height:44px; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.12); background:var(--card-bg); resize:vertical; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; margin:10px 12px; }
    .btn { height:44px; padding:0 16px; border-radius:12px; }
    .chip { height:40px; padding:0 14px; border-radius:999px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0; }
    .filters .chip { background:var(--card-bg); border:1px solid rgba(0,0,0,.06); }
    .list { width:100%; border-collapse:collapse; background:var(--card-bg); border-radius:12px; overflow:hidden; }
    .list th,.list td{ padding:10px; border-bottom:1px solid rgba(0,0,0,.06); font-size:13px; text-align:left; }
    .list th{ background:rgba(0,0,0,.04); font-weight:600; }
    html[data-theme="dark"] .list th{ background:rgba(255,255,255,.06); }
    .muted-note{ font-size:12px; color:var(--muted); margin-top:10px; }
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <!-- Toolbar -->
  <nav class="toolbar">
    <a class="chip" href="admin.html">‚Üê Supervisor</a>
    <a class="chip" href="dashboard.html">Doctor</a>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <!-- Create Booking -->
  <section class="section tint tint-blue">
    <h2 style="font-size:22px; margin-bottom:10px;">Create Booking (Token)</h2>

    <div class="tint tint-purple" style="margin-top:8px;">
      <div class="grid-2">
        <div class="field">
          <label class="label" for="patName">Patient Name</label>
          <input id="patName" class="input" placeholder="Full name" autocomplete="name" required/>
        </div>
        <div class="field">
          <label class="label" for="patPhone">Phone</label>
          <input id="patPhone" class="input" inputmode="numeric" maxlength="10" placeholder="10-digit" autocomplete="tel" required/>
        </div>

        <div class="field">
          <label class="label" for="visitDate">Visit Date</label>
          <input id="visitDate" class="input" type="date" required/>
        </div>
        <div class="field">
          <label class="label" for="visitTime">Time</label>
          <input id="visitTime" class="input" type="time" required/>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label class="label" for="reason">Reason / Notes</label>
          <textarea id="reason" class="textarea" placeholder="Reason or short note"></textarea>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button id="createBtn" class="btn">Create Token</button>
        <button id="waBtn" class="chip">Share via WhatsApp</button>
      </div>

      <p class="muted-note">
        Supervisor creates tokens. Doctor sees them on Patients/Bookings views.  
        Token numbers auto-increment per day.
      </p>
    </div>
  </section>

  <!-- Upcoming -->
  <section class="section tint" style="background: color-mix(in srgb, #22c55e 10%, var(--card-bg));">
    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
      <h2 style="font-size:22px;">Upcoming Tokens</h2>
      <div class="filters">
        <button class="chip" id="fToday">Today</button>
        <button class="chip" id="fAll">All</button>
        <button class="chip" id="fClear">Clear List</button>
      </div>
    </div>

    <table class="list" style="margin-top:10px;">
      <thead>
        <tr>
          <th>#</th><th>Name</th><th>Phone</th><th>Date</th><th>Time</th><th>Notes</th>
        </tr>
      </thead>
      <tbody id="bookRows">
        <!-- rows injected -->
      </tbody>
    </table>
  </section>

  <script type="module">
    // --- Theme toggle
    const tt=document.getElementById('themeToggle');
    if(localStorage.theme){ document.documentElement.dataset.theme=localStorage.theme; tt.textContent=localStorage.theme==='light'?'üåû':'üåô'; }
    tt.onclick=()=>{ const cur=document.documentElement.dataset.theme||'light'; const next=cur==='light'?'dark':'light'; document.documentElement.dataset.theme=next; localStorage.theme=next; tt.textContent=next==='light'?'üåû':'üåô'; };

    // --- Guard: Supervisor only
    const sess = JSON.parse(localStorage.getItem('session')||'{}');
    if(sess.role!=='supervisor'){ location.replace('login.html'); }

    // --- Buttons
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('session'); location.href='login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      localStorage.clear(); sessionStorage.clear();
      if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
      alert('Cleared. Reloading‚Ä¶'); location.reload();
    };

    // --- Elements
    const nameEl=document.getElementById('patName');
    const phoneEl=document.getElementById('patPhone');
    const dateEl=document.getElementById('visitDate');
    const timeEl=document.getElementById('visitTime');
    const noteEl=document.getElementById('reason');
    const rowsEl=document.getElementById('bookRows');

    // Defaults
    const todayISO = new Date().toISOString().slice(0,10);
    dateEl.value = todayISO;
    timeEl.value = new Date(Date.now()+15*60000).toTimeString().slice(0,5); // +15m

    // Storage helpers (local for now; swap to Supabase later)
    const load = () => JSON.parse(localStorage.getItem('bookings')||'[]');
    const save = (arr) => localStorage.setItem('bookings', JSON.stringify(arr));

    // Generate next token number for a given date
    function nextTokenFor(dateISO){
      const all=load().filter(b=>b.date===dateISO);
      const last = all.sort((a,b)=>a.token-b.token).pop();
      return last ? last.token+1 : 1;
    }

    function render(filter='today'){
      const all=load();
      let list = all;
      if(filter==='today') list = all.filter(b=>b.date===todayISO);

      rowsEl.innerHTML = list
        .sort((a,b)=> a.date.localeCompare(b.date) || a.time.localeCompare(b.time) || a.token-b.token)
        .map(b=>`<tr>
          <td>${b.token}</td>
          <td>${b.name}</td>
          <td>${b.phone}</td>
          <td>${b.date}</td>
          <td>${b.time}</td>
          <td>${b.note||''}</td>
        </tr>`).join('') || `<tr><td colspan="6" class="muted-note">No tokens.</td></tr>`;
    }

    // Create Token
    document.getElementById('createBtn').onclick=()=>{
      const name=(nameEl.value||'').trim();
      const phone=(phoneEl.value||'').trim();
      const date=dateEl.value;
      const time=timeEl.value;
      const note=(noteEl.value||'').trim();

      if(!name || !/^\d{10}$/.test(phone) || !date || !time){
        alert('Please enter a name, a 10-digit phone, date and time.');
        return;
      }

      const token = nextTokenFor(date);
      const rec = { id: crypto.randomUUID(), token, name, phone, date, time, note, createdAt: Date.now() };

      const arr = load(); arr.push(rec); save(arr);
      render('today');

      // Reset name/note only
      nameEl.value=''; noteEl.value='';
      nameEl.focus();

      // Keep a copy for Share button
      lastShared = rec;
    };

    // Share via WhatsApp
    let lastShared = null;
    document.getElementById('waBtn').onclick=()=>{
      const name=(nameEl.value||'').trim();
      const phone=(phoneEl.value||'').trim();
      const date=dateEl.value, time=timeEl.value, note=noteEl.value||'';
      const tok = nextTokenFor(date); // preview
      const msg = encodeURIComponent(
        `Dr. Charan Hospital\nToken: ${tok}\nName: ${name||'-'}\nDate: ${date}\nTime: ${time}\n${note?('Note: '+note+'\n'):''}Please arrive 10 min early.`
      );
      const tel = phone ? `91${phone}` : '';
      const url = tel ? `https://wa.me/${tel}?text=${msg}` : `https://wa.me/?text=${msg}`;
      window.open(url, '_blank');
    };

    // Filters
    document.getElementById('fToday').onclick=()=>render('today');
    document.getElementById('fAll').onclick=()=>render('all');
    document.getElementById('fClear').onclick=()=>{
      if(confirm('Clear all tokens (local only)?')){ save([]); render('today'); }
    };

    // Initial render
    render('today');

    // SW
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
