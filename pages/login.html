<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PIN Login ¬∑ Hospital ERP</title>
  <link rel="stylesheet" href="../styles/styles.css" />
  <style>
    :root { --radius:16px; }
    body {
      font-family: system-ui, Segoe UI, Roboto, sans-serif;
      background: #f5f7fb;
      min-height: 100vh;
      margin: 0;
      display: grid;
      place-items: center;
    }
    .wrap {
      width: min(92vw, 420px);
    }
    .login-card {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(2,6,23,.12), 0 3px 10px rgba(2,6,23,.06);
      padding: 24px 22px;
    }
    .title {
      margin: 2px 0 14px;
      text-align: center;
      font-weight: 800;
      font-size: 1.6rem;
      color: #0b1220;
    }
    .hint { color:#6b7280; font-size:.95rem; text-align:center; margin-bottom:14px; }
    .input-group {
      display:flex; align-items:center; gap:10px;
      border-radius: 12px; padding: 12px 14px;
      background: #eef2ff; border: 1px solid #dbe4ff;
    }
    .input-group input {
      border:0; outline:0; background:transparent; flex:1;
      font-size:1.05rem; letter-spacing:.08em;
    }
    .eye { cursor:pointer; user-select:none; opacity:.7 }
    .row { display:flex; gap:12px; justify-content:center; margin:16px 0 10px }
    .btn {
      border:0; border-radius: 12px; padding: 11px 18px; font-size:1rem; cursor:pointer;
      transition: transform .05s ease, background .15s ease, box-shadow .15s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background:#2563eb; color:#fff; box-shadow:0 6px 16px rgba(37,99,235,.35) }
    .btn-primary:hover { background:#1e4ed8; }
    .btn-ghost { background:#f3f4f6; color:#111827; }
    .btn-ghost:hover { background:#e5e7eb; }
    .demo {
      text-align:center; color:#374151; font-size:.95rem; margin-top:6px;
    }
    .demo b { font-weight:800; }
    .foot {
      display:flex; justify-content:center; gap:10px; margin-top:14px;
    }
    .foot a { color:#6b7280; font-size:.9rem; text-decoration:none }
    .foot a:hover { text-decoration:underline }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="login-card">
      <div class="title">üîí PIN Login</div>
      <div class="hint">Enter your 4‚Äì6 digit PIN to continue</div>

      <div class="input-group">
        <span aria-hidden="true">üîë</span>
        <input
          id="pinInput"
          type="password"
          inputmode="numeric"
          pattern="[0-9]*"
          autocomplete="one-time-code"
          maxlength="6"
          placeholder="4‚Äì6 digits"
        />
        <span id="toggleEye" class="eye" title="Show/Hide PIN">üëÅÔ∏è</span>
      </div>

      <div class="row">
        <button id="btnLogin" class="btn btn-primary">Login</button>
        <button id="btnClear" class="btn btn-ghost">Clear Cache</button>
      </div>

      <div class="demo" id="demoPins">Demo PINs ‚Üí <b>4321</b> (Doctor) ¬∑ <b>1111</b> (Supervisor) ¬∑ <b>9999</b> (Admin)</div>

      <div class="foot">
        <a href="./index.html">‚Üê Dashboard</a>
      </div>
    </div>
  </div>

  <script>
    // --- helpers ----------------------------------------------------------
    const qs = (s, r=document) => r.querySelector(s);
    const getNext = () => new URLSearchParams(location.search).get('next');
    const baseGoto = (file) => { const base = location.pathname.replace(/[^/]+$/, ''); location.href = base + file; };

    // Seed demo PINs if missing (keeps any user-changed pins)
    if (!localStorage.getItem('erp:pin_doctor'))     localStorage.setItem('erp:pin_doctor', '4321');
    if (!localStorage.getItem('erp:pin_supervisor')) localStorage.setItem('erp:pin_supervisor', '1111');
    if (!localStorage.getItem('erp:pin_admin'))      localStorage.setItem('erp:pin_admin', '9999');

    // Reflect whatever is currently stored as the demo text (avoids mismatch)
    (function refreshDemoPins(){
      const d = localStorage.getItem('erp:pin_doctor') || '4321';
      const s = localStorage.getItem('erp:pin_supervisor') || '1111';
      const a = localStorage.getItem('erp:pin_admin') || '9999';
      qs('#demoPins').innerHTML = `Demo PINs ‚Üí <b>${d}</b> (Doctor) ¬∑ <b>${s}</b> (Supervisor) ¬∑ <b>${a}</b> (Admin)`;
    })();

    // Toggle show/hide PIN
    qs('#toggleEye').addEventListener('click', () => {
      const i = qs('#pinInput');
      i.type = i.type === 'password' ? 'text' : 'password';
    });

    // Only allow digits
    qs('#pinInput').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D+/g, '').slice(0, 6);
    });

    // Login logic ‚Üí sets role + auth flag, then routes to dashboard (or ?next)
    function handleLogin() {
      const pin = (qs('#pinInput').value || '').trim();
      if (!/^\d{4,6}$/.test(pin)) { alert('Enter a 4‚Äì6 digit PIN'); return; }

      const pins = {
        doctor:     localStorage.getItem('erp:pin_doctor')     || '4321',
        supervisor: localStorage.getItem('erp:pin_supervisor') || '1111',
        admin:      localStorage.getItem('erp:pin_admin')      || '9999',
      };

      let role = '';
      if (pin === pins.admin)      role = 'admin';
      else if (pin === pins.supervisor) role = 'supervisor';
      else if (pin === pins.doctor)     role = 'doctor';

      if (!role) { alert('Invalid PIN. Please try again.'); return; }

      localStorage.setItem('erp:auth', 'true');
      localStorage.setItem('erp:role', role);

      const next = getNext();
      if (next) {
        // if next is an absolute URL, keep it safe and only allow same-origin
        try {
          const u = new URL(decodeURIComponent(next), location.origin);
          if (u.origin === location.origin) location.href = u.href;
          else baseGoto('index.html');
        } catch { baseGoto('index.html'); }
      } else {
        // Always go to dashboard; role-specific areas can gate on role later
        baseGoto('index.html');
      }
    }

    // Clear cache but keep demo PINs (so the page remains usable)
    async function clearCache() {
      const keep = ['erp:pin_doctor','erp:pin_supervisor','erp:pin_admin','theme','erp:fmt'];
      Object.keys(localStorage).forEach(k => { if (!keep.includes(k)) localStorage.removeItem(k); });
      if ('caches' in window) {
        const names = await caches.keys(); await Promise.all(names.map(n => caches.delete(n)));
      }
      alert('Cache cleared (PINs preserved).');
      location.reload();
    }

    // Bind
    qs('#btnLogin').addEventListener('click', handleLogin);
    qs('#btnClear').addEventListener('click', clearCache);
    qs('#pinInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleLogin(); });
    // autofocus
    setTimeout(() => qs('#pinInput')?.focus(), 50);
  </script>
</body>
</html>
