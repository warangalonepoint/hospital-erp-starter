<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supervisor ‚Ä¢ Hospital ERP</title>
  <link rel="stylesheet" href="../styles/styles.css" />
  <!-- optional: if you also use ui.css -->
  <!-- <link rel="stylesheet" href="../styles/ui.css" /> -->
  <link rel="icon" href="../public/manifest-icon-192.png" />
  <script src="../scripts/utils.js"></script>
  <style>
    /* local helpers */
    .brand{display:flex;align-items:center;gap:8px;font-weight:900}
    .brand-title{font-size:1.1rem}
    #who{margin-left:auto}
    .grid{display:grid;gap:16px}
    @media (min-width: 980px){ .grid.cols-2{ grid-template-columns: 1.1fr .9fr } }
    .cards-3{display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width: 860px){ .cards-3{grid-template-columns:repeat(3,1fr)} }
    .table { width:100%; border-collapse:separate; border-spacing:0; background:var(--paper); border:1px solid var(--line); border-radius:14px; overflow:hidden; box-shadow:var(--shadow-sm) }
    .table th,.table td{ padding:10px 12px; border-bottom:1px solid var(--line); text-align:left }
    .table th{ background:color-mix(in srgb, var(--paper) 80%, var(--bg)); color:var(--ink-muted); font-weight:700 }
    .table tr:last-child td{ border-bottom:none }
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <div class="brand">
      <span class="brand-mark">üóÇÔ∏è</span>
      <span class="brand-title">Supervisor</span>
    </div>
    <span id="who" class="muted"></span>
    <button id="themeToggle" class="toggle" title="Toggle theme">üåô</button>
  </header>

  <!-- Toolbar -->
  <nav class="toolbar">
    <a class="chip" href="./dashboard.html">‚Üê Dashboard</a>
    <a class="chip" href="./analytics.html">Analytics</a>
    <a class="chip" href="./pharmacy.html">Pharmacy</a>
    <span style="flex:1"></span>
    <button id="btnLogout" class="chip">Logout</button>
    <button id="btnClear" class="chip">Clear Cache</button>
  </nav>

  <!-- Hero panels -->
  <main class="section">
    <div class="cards-3">
      <a class="card panel--lilac card panel grad-lilac" href="./analytics.html">
        <h3>Today KPIs</h3>
        <p class="muted">Pharmacy sales, items sold, patients due</p>
      </a>

      <a class="card" style="background-image:var(--grad-blue); color:#eef2ff; border-color:#22324a" href="./pharmacy.html">
        <h3>Quick Actions</h3>
        <p class="muted" style="color:#e6ecff">Sell, stock, and returns</p>
      </a>

      <a class="card" style="background-image:var(--grad-mint); color:#ecfffb; border-color:#1c3d34" href="#today">
        <h3>Today‚Äôs List</h3>
        <p class="muted" style="color:#c9fff3">Appointments & reminders</p>
      </a>
    </div>
  </main>

  <!-- Content: KPIs + Lists -->
  <section class="section grid cols-2">
    <!-- Left: KPIs + Today -->
    <div class="grid" style="gap:16px">
      <div class="card">
        <h3>Today‚Äôs KPIs</h3>
        <div class="kpi-grid mt12">
          <div class="kpi">
            <div class="label">Sales (Today)</div>
            <div id="kpiSalesToday" class="value money">‚Çπ 0.00</div>
          </div>
          <div class="kpi">
            <div class="label">Items Sold</div>
            <div id="kpiItemsToday" class="value">0</div>
          </div>
          <div class="kpi">
            <div class="label">Invoices Today</div>
            <div id="kpiInvToday" class="value">0</div>
          </div>
          <div class="kpi">
            <div class="label">Patients Due</div>
            <div id="kpiDueToday" class="value">0</div>
          </div>
          <div class="kpi">
            <div class="label">Top Item (MTD)</div>
            <div id="kpiTopItem" class="value nowrap">‚Äî</div>
          </div>
        </div>
      </div>

      <div id="today" class="card">
        <h3>Today‚Äôs Appointments / Follow-ups</h3>
        <table class="table" id="tblToday">
          <thead>
            <tr>
              <th>Patient</th>
              <th>ID</th>
              <th>Reason</th>
              <th>Date</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody><!-- filled by JS --></tbody>
        </table>
      </div>
    </div>

    <!-- Right: Recent sales -->
    <div class="card">
      <h3>Recent Pharmacy Sales</h3>
      <table class="table" id="tblSales">
        <thead>
          <tr>
            <th># Invoice</th>
            <th>Date</th>
            <th>Items</th>
            <th class="right">Total</th>
          </tr>
        </thead>
        <tbody><!-- filled by JS --></tbody>
      </table>
    </div>
  </section>

  <footer class="section center muted">Supervisor ¬∑ Hospital ERP</footer>

  <script>
    /* ===== Guard: supervisor only ===== */
    (function guard(){
      try {
        if (window.ERP?.requireRole) { ERP.requireRole('supervisor', './login.html'); return; }
      } catch {}
      const role = localStorage.getItem('erp:role') || localStorage.getItem('role');
      if (role !== 'supervisor') location.replace('./login.html');
    })();

    /* ===== Theme toggle (unified) ===== */
    (function theme(){
      const root = document.documentElement;
      const btn  = document.getElementById('themeToggle');
      const saved = localStorage.getItem('theme') || 'light';
      root.dataset.theme = saved;
      btn.textContent = saved === 'dark' ? 'üåô' : 'üåû';
      btn.onclick = () => {
        const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
        root.dataset.theme = next;
        localStorage.setItem('theme', next);
        btn.textContent = next === 'dark' ? 'üåô' : 'üåû';
      };
    })();

    /* ===== Toolbar actions ===== */
    document.getElementById('btnLogout').onclick = () => {
      localStorage.removeItem('role');
      localStorage.removeItem('erp:role');
      localStorage.removeItem('erp:auth');
      location.href = './login.html';
    };
    document.getElementById('btnClear').onclick = async () => {
      const keep = new Set(['theme','pins','erp:pin_doctor','erp:pin_supervisor','erp:pin_admin']);
      for (const k of Object.keys(localStorage)) if (!keep.has(k)) localStorage.removeItem(k);
      if ('caches' in window) {
        const names = await caches.keys(); await Promise.all(names.map(n => caches.delete(n)));
      }
      alert('Cleared local data (kept theme & PINs).');
      location.reload();
    };

    /* ===== Page data ===== */
    (function hydrate(){
      const fm = (n)=> window.ERP?.formatMoney ? ERP.formatMoney(n) : `‚Çπ ${(n||0).toFixed(2)}`;
      const ymd = (d)=> window.ERP?.ymd?.(d) || (new Date(d).toISOString().slice(0,10));
      const today = window.ERP?.todayISO?.() || new Date().toISOString().slice(0,10);

      const invoices = window.ERP?.load?.('invoices', []) || [];
      const items    = window.ERP?.load?.('invoice_items', []) || [];
      const pats     = window.ERP?.load?.('patients', []) || [];

      // --- KPIs (today) ---
      const invById = new Map(invoices.map(i => [String(i.id || i.invoice_id), i]));

      const invToday = invoices.filter(inv => ymd(inv.date || inv.invoice_date) === today);
      const itemsToday = items.filter(it => {
        const inv = invById.get(String(it.invoice_id));
        return inv && ymd(inv.date || inv.invoice_date) === today;
      });

      const kpi = window.ERP?.buildSalesKPIs ? ERP.buildSalesKPIs(invToday, itemsToday) : {total:0, itemsSold:0};
      document.getElementById('kpiSalesToday').textContent = fm(kpi.total || 0);
      document.getElementById('kpiItemsToday').textContent = kpi.itemsSold || 0;
      document.getElementById('kpiInvToday').textContent   = invToday.length || 0;

      // Patients due today (uses next_followup/next_visit/followup)
      const due = pats.filter(p => {
        const d = p.next_followup || p.next_visit || p.followup || '';
        return d && ymd(d) === today;
      });
      document.getElementById('kpiDueToday').textContent = due.length;

      // Top item MTD
      const first = new Date(); first.setDate(1);
      const firstYMD = ymd(first);
      const itemsMTD = items.filter(it => {
        const inv = invById.get(String(it.invoice_id));
        const d = inv ? ymd(inv.date || inv.invoice_date) : null;
        return d && d >= firstYMD && d <= today;
      });
      const top = window.ERP?.topItems ? ERP.topItems(itemsMTD, 1)[0] : null;
      document.getElementById('kpiTopItem').textContent = top ? (top.name || '‚Äî') : '‚Äî';

      // --- Today‚Äôs list (appointments/follow-ups) ---
      const tbodyToday = document.querySelector('#tblToday tbody');
      tbodyToday.innerHTML = due.slice(0, 10).map(p => `
        <tr>
          <td>${p.name || p.full_name || '‚Äî'}</td>
          <td class="nowrap">${p.patient_id || p.id || '‚Äî'}</td>
          <td>${p.reason || p.visit_reason || p.dept || '‚Äî'}</td>
          <td class="nowrap">${ymd(p.next_followup || p.next_visit || p.followup)}</td>
          <td class="right"><a class="chip" href="./admin.html#patients">Open</a></td>
        </tr>
      `).join('') || `<tr><td colspan="5" class="muted">No follow-ups due today.</td></tr>`;

      // --- Recent sales (last 8 invoices) ---
      const tbodySales = document.querySelector('#tblSales tbody');
      const recents = [...invoices]
        .sort((a,b)=> (new Date(b.date||b.invoice_date)) - (new Date(a.date||a.invoice_date)))
        .slice(0, 8);

      // Pre-count items per invoice
      const countItems = (invId) => items.reduce((n,it)=> n + (String(it.invoice_id)===String(invId)? (Number(it.qty)||0):0), 0);

      tbodySales.innerHTML = recents.map(inv => {
        const id = inv.id || inv.invoice_id || '‚Äî';
        const total = inv.total ?? inv.grand_total;
        const cnt = countItems(id);
        return `
          <tr>
            <td>${id}</td>
            <td class="nowrap">${ymd(inv.date || inv.invoice_date)}</td>
            <td>${cnt}</td>
            <td class="right">${fm(total || 0)}</td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="4" class="muted">No recent sales.</td></tr>`;
    })();

    // Show signed-in role
    (function showRole(){
      const role = localStorage.getItem('erp:role') || localStorage.getItem('role') || '';
      const who = document.getElementById('who');
      if (role && who) who.textContent = `Signed in as ${role}`;
    })();
  </script>
</body>
</html>
