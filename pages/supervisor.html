<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Supervisor ‚Ä¢ Hospital ERP</title>
  <link rel="stylesheet" href="../styles/styles.css"/>
  <link rel="icon" href="../public/assets/icon-192.png"/>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="toggle" title="Toggle theme">üåô</button>
  </header>

  <!-- Top actions -->
  <div class="toolbar">
    <a class="chip" href="./dashboard.html">‚Üê Dashboard</a>
    <button class="chip" id="btnClear">Clear Cache</button>
    <div style="flex:1"></div>
    <a class="chip admin-only" href="./admin.html">Admin</a>
  </div>

  <!-- Header -->
  <section class="section">
    <div class="panel grad-lilac">
      <h2>Supervisor Snapshot</h2>
      <p class="muted">Daily performance, quick exports, and team view.</p>
    </div>

    <div class="row mt12">
      <input type="date" id="from" style="max-width:180px">
      <input type="date" id="to" style="max-width:180px">
      <button id="btnRun" class="chip chip--primary">Run</button>
      <button class="chip" data-q="today">Today</button>
      <button class="chip" data-q="7d">Last 7D</button>
      <button class="chip" data-q="30d">Last 30D</button>
      <button class="chip" data-q="mtd">MTD</button>
      <div style="flex:1"></div>
      <button id="btnExportInvoices" class="chip">‚Üì Invoices CSV</button>
      <button id="btnExportItems" class="chip">‚Üì Items CSV</button>
    </div>
  </section>

  <!-- KPIs -->
  <section class="section">
    <div class="kpi-grid">
      <div class="kpi" style="background:var(--t-blue);color:var(--c-blue)">
        <h4>Total (‚Çπ)</h4><div class="num" id="kTotal">0.00</div>
      </div>
      <div class="kpi" style="background:var(--t-mint);color:var(--c-mint)">
        <h4>Paid (‚Çπ)</h4><div class="num" id="kPaid">0.00</div>
      </div>
      <div class="kpi" style="background:var(--t-peach);color:var(--c-peach)">
        <h4>Invoices</h4><div class="num" id="kInv">0</div>
      </div>
      <div class="kpi" style="background:var(--t-rose);color:var(--c-rose)">
        <h4>Avg/Day (‚Çπ)</h4><div class="num" id="kAvg">0.00</div>
      </div>
    </div>
  </section>

  <!-- Charts -->
  <section class="section">
    <div class="grid-2">
      <div class="chart-wrap">
        <div class="chart-title">Revenue by Day</div>
        <canvas id="revChart" aria-label="Revenue line" style="width:100%;height:260px"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-title">Top 10 Items (‚Çπ)</div>
        <canvas id="topChart" aria-label="Top items bar" style="width:100%;height:260px"></canvas>
      </div>
    </div>
  </section>

  <!-- Tables -->
  <section class="section">
    <h3 style="margin:0 0 8px">Top Items</h3>
    <div style="overflow:auto">
      <table class="table">
        <thead><tr><th>#</th><th>Item</th><th>Qty</th><th>Amount (‚Çπ)</th></tr></thead>
        <tbody id="topBody"><tr><td class="muted" colspan="4">‚Äî</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <h3 style="margin:0 0 8px">Recent Invoices</h3>
    <div style="overflow:auto">
      <table class="table">
        <thead><tr><th>Date</th><th>Invoice #</th><th>Patient</th><th>Total</th><th>Paid</th></tr></thead>
        <tbody id="invBody"><tr><td class="muted" colspan="5">‚Äî</td></tr></tbody>
      </table>
    </div>
  </section>

  <script src="../scripts/utils.js"></script>
  <script>
    // ================= Theme toggle =================
    (function(){
      const key='theme', root=document.documentElement, btn=document.getElementById('themeToggle');
      const saved=localStorage.getItem(key)||'light'; root.dataset.theme=saved; btn.textContent=saved==='dark'?'üåô':'üåû';
      btn.onclick=()=>{ const next=root.dataset.theme==='dark'?'light':'dark'; root.dataset.theme=next; localStorage.setItem(key,next); btn.textContent=next==='dark'?'üåô':'üåû'; };
    })();

    // ================= Role-based visibility =================
    (function guard(){
      const role = localStorage.getItem('erp:role') || sessionStorage.getItem('role');
      // Allow supervisor and admin; hide admin-only links if not admin
      if (role !== 'supervisor' && role !== 'admin') {
        // If they came here directly, bounce to login
        location.replace('./login.html');
        return;
      }
      if (role !== 'admin') document.querySelectorAll('.admin-only').forEach(el => el.remove());
    })();

    // ================= Clear cache =================
    document.getElementById('btnClear').onclick = async ()=>{
      const keep=['theme','erp:pin_doctor','erp:pin_supervisor','erp:pin_admin','erp:startup','erp:fmt','erp:auth','erp:role'];
      Object.keys(localStorage).forEach(k=>{ if(!keep.includes(k)) localStorage.removeItem(k); });
      if('caches' in window){ const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
      alert('Cache cleared (PINs/preferences preserved).');
    };

    // ================= Date helpers =================
    const $ = (id)=> document.getElementById(id);
    const fromEl=$('from'), toEl=$('to');
    function setRange(days){
      const to = new Date(); to.setHours(0,0,0,0);
      const from = new Date(to); from.setDate(to.getDate()-days+1);
      fromEl.value = from.toISOString().slice(0,10);
      toEl.value   = to.toISOString().slice(0,10);
    }
    function setMTD(){
      const d=new Date(); fromEl.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`; toEl.value=new Date().toISOString().slice(0,10);
    }
    document.querySelectorAll('[data-q]').forEach(b => b.onclick = ()=>{
      const q=b.dataset.q; if(q==='today') setRange(1); if(q==='7d') setRange(7); if(q==='30d') setRange(30); if(q==='mtd') setMTD();
      run();
    });

    // ================= Charts (lightweight canvas) =================
    function drawBars(canvasId, labels, values){
      const cvs = document.getElementById(canvasId), ctx=cvs.getContext('2d');
      const W = cvs.clientWidth || 540, H = 260; cvs.width=W*devicePixelRatio; cvs.height=H*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
      ctx.clearRect(0,0,W,H);
      const pad=28, gap=10, n=values.length||1, bw=(W-pad*2-gap*(n-1))/n;
      const max=Math.max(1, ...values.map(v=>+v||0));
      const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#2563eb';
      ctx.font='12px Inter, system-ui, sans-serif'; ctx.fillStyle='currentColor';
      values.forEach((v,i)=>{
        const h=Math.round((v/max)*(H-70)), x=pad+i*(bw+gap), y=H-40-h;
        ctx.fillStyle=accent; ctx.fillRect(x,y,bw,h);
        ctx.globalAlpha=.85; ctx.fillStyle='currentColor'; ctx.fillText(labels[i]||'', x, H-20); ctx.globalAlpha=1;
      });
    }
    function drawLine(canvasId, labels, values){
      const cvs = document.getElementById(canvasId), ctx=cvs.getContext('2d');
      const W = cvs.clientWidth || 540, H = 260; cvs.width=W*devicePixelRatio; cvs.height=H*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
      ctx.clearRect(0,0,W,H);
      const pad=28, n=values.length||1;
      const max=Math.max(1, ...values.map(v=>+v||0));
      const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#2563eb';
      const innerW = W - pad*2, step = innerW / Math.max(1,n-1);
      ctx.strokeStyle = accent; ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((v,i)=>{
        const x = pad + i*step;
        const y = (H-40) - (v/max)*(H-70);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      // labels
      ctx.font='12px Inter, system-ui, sans-serif'; ctx.fillStyle='currentColor'; ctx.globalAlpha=.85;
      labels.forEach((t,i)=>{ const x=pad + i*step; ctx.fillText(t, x-8, H-20); });
      ctx.globalAlpha=1;
    }

    // ================= Data & rendering =================
    function run(){
      const invsAll = ERP.load('invoices', []);
      const itemsAll = ERP.load('invoice_items', []);
      const invs = ERP.filterInvoicesByDate(invsAll, fromEl.value, toEl.value);
      const ids = new Set(invs.map(i => i.id || i.invoice_id));
      const items = itemsAll.filter(x => ids.has(x.invoice_id));

      // KPIs
      const k = ERP.buildSalesKPIs(invs, items);
      $('kTotal').textContent = k.total.toFixed(2);
      $('kPaid').textContent  = k.paid.toFixed(2);
      $('kInv').textContent   = String(k.invoices);
      const days = Math.max(1, Math.ceil((new Date(toEl.value) - new Date(fromEl.value))/86400000) + 1);
      $('kAvg').textContent   = (k.total/days).toFixed(2);

      // Revenue series (line)
      const byId = new Map(invs.map(i => [(i.id||i.invoice_id), i]));
      const series = ERP.dailyRevenue(items, byId); // [{date, amount}]
      // Fill missing dates within range
      const dFrom = new Date(fromEl.value), dTo = new Date(toEl.value);
      const labels=[], values=[];
      for(let d=new Date(dFrom); d<=dTo; d.setDate(d.getDate()+1)){
        const key = d.toISOString().slice(0,10);
        const found = series.find(s => s.date === key)?.amount || 0;
        labels.push(`${key.slice(8,10)}/${key.slice(5,7)}`);
        values.push(+found.toFixed(2));
      }
      drawLine('revChart', labels, values);

      // Top items (table + bars)
      const top = ERP.topItems(items, 10);
      const body = $('topBody');
      body.innerHTML = top.length
        ? top.map((r,i)=> `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.qty}</td><td>‚Çπ ${r.amount.toFixed(2)}</td></tr>`).join('')
        : '<tr><td class="muted" colspan="4">‚Äî</td></tr>';
      drawBars('topChart', top.map(t=>t.name.slice(0,8)), top.map(t=>t.amount));

      // Recent invoices (latest 12)
      const invBody = $('invBody');
      const recent = [...invs].sort((a,b)=> new Date(b.date||b.invoice_date) - new Date(a.date||a.invoice_date)).slice(0,12);
      invBody.innerHTML = recent.length
        ? recent.map(r => `<tr>
            <td>${(r.date||r.invoice_date)||''}</td>
            <td>${r.id||r.invoice_id||''}</td>
            <td>${(r.patient_name||'')}${r.patient_id?` (${r.patient_id})`:''}</td>
            <td>‚Çπ ${(Number(r.total||0)).toFixed(2)}</td>
            <td>‚Çπ ${(Number(r.paid||0)).toFixed(2)}</td>
          </tr>`).join('')
        : '<tr><td class="muted" colspan="5">‚Äî</td></tr>';
    }

    // Export buttons
    $('btnExportInvoices').onclick = ()=> ERP.downloadCSV('invoices_filtered.csv', ERP.filterInvoicesByDate(ERP.load('invoices', []), fromEl.value, toEl.value));
    $('btnExportItems').onclick = ()=>{
      const invs = ERP.filterInvoicesByDate(ERP.load('invoices', []), fromEl.value, toEl.value);
      const ids = new Set(invs.map(i=> i.id||i.invoice_id));
      const items = ERP.load('invoice_items', []).filter(x=> ids.has(x.invoice_id));
      ERP.downloadCSV('invoice_items_filtered.csv', items);
    };

    // Init
    (async function init(){
      // Load CSVs to LS on first run (best-effort)
      if(!ERP.load('invoices').length){ try{ await ERP.loadAllCSVs(); }catch(e){} }
      // default range = last 7 days
      setRange(7);
      $('btnRun').onclick = run;
      run();
    })();
  </script>
</body>
</html>
