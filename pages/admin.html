<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Ä¢ Hospital ERP</title>
  <link rel="stylesheet" href="../styles/styles.css" />
  <link rel="stylesheet" href="../styles/ui.css" />
  <link rel="icon" href="../public/assets/icon-192.png">
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <div class="brand">
      <span class="brand-mark">üõ†Ô∏è</span>
      <span class="brand-title">Admin</span>
    </div>
    <button id="themeToggle" class="toggle" title="Toggle theme">üåô</button>
  </header>

  <!-- Toolbar -->
  <nav class="toolbar">
    <a class="chip" href="./login.html">‚Üê Login</a>
    <a class="chip" href="./dashboard.html">Dashboard</a>
    <button id="btnClear" class="chip">Clear Cache</button>
  </nav>

  <main class="section">
    <!-- Quick links -->
    <div class="card-grid" style="margin-bottom:18px">
      <a class="card grad-sky" href="./pharmacy.html">
        <h2>Pharmacy</h2>
        <p>Sell ‚Ä¢ Purchase ‚Ä¢ Stock ‚Ä¢ Reports</p>
      </a>
      <a class="card grad-lavender" href="./settings.html">
        <h2>Settings</h2>
        <p>Patients & Staff tools</p>
      </a>
    </div>

    <!-- Inventory Tools -->
    <section class="panel" aria-label="Inventory Tools">
      <h2 style="margin-top:0">Inventory Tools</h2>

      <div class="card-grid" style="margin-top:12px">
        <!-- Scan to upload -->
        <div class="card" style="background:var(--panel); color:var(--fg); border:1px solid var(--line)">
          <h3>üì∑ Scan to Upload Stock</h3>
          <p class="muted">Use the camera to scan an item barcode, then save/update stock.</p>

          <div class="row" style="margin-top:10px">
            <button id="scanStart" class="chip">Start Scanner</button>
            <button id="scanStop" class="chip">Stop</button>
            <span class="muted" id="scanStatus">‚Äî</span>
          </div>

          <div id="scanVideo" style="height:260px;border-radius:12px;background:#000;margin-top:10px;overflow:hidden"></div>

          <div class="row" style="margin-top:12px">
            <input id="iName" placeholder="Item name" style="flex:1">
            <input id="iBarcode" placeholder="Barcode" style="max-width:220px">
            <input id="iBatch" placeholder="Batch" style="max-width:160px">
            <input id="iExpiry" placeholder="YYYY-MM" style="max-width:140px">
          </div>
          <div class="row" style="margin-top:10px">
            <input id="iMRP" type="number" step="0.01" placeholder="MRP" style="max-width:160px">
            <input id="iGST" type="number" step="0.01" placeholder="GST %" style="max-width:160px">
            <input id="iQty" type="number" step="1" placeholder="Qty" style="max-width:160px">
            <button id="btnSaveStock" class="chip" style="background:#0ea5e9;border-color:transparent;color:#06121f;font-weight:700">Save to Stock</button>
          </div>
        </div>

        <!-- CSV import/export -->
        <div class="card" style="background:var(--panel); color:var(--fg); border:1px solid var(--line)">
          <h3>‚¨Ü Import Inventory (CSV)</h3>
          <p class="muted">Columns flexible: code/name/batch/qty/mrp/gst/expiry (barcode/code merged).</p>
          <input type="file" id="invCSVFile" accept=".csv" />
          <div class="row" style="margin-top:10px">
            <button id="btnImportCSV" class="chip">Import</button>
            <button id="btnExportInv" class="chip">Export Inventory</button>
            <span id="importStatus" class="muted">‚Äî</span>
          </div>
          <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">
          <h4>Quick Exports</h4>
          <div class="row">
            <button id="btnExportPatients" class="chip">Patients.csv</button>
            <button id="btnExportInvoices" class="chip">Invoices.csv</button>
            <button id="btnExportInvItems" class="chip">Invoice_Items.csv</button>
          </div>
        </div>

        <!-- Backup / Restore -->
        <div class="card" style="background:var(--panel); color:var(--fg); border:1px solid var(--line)">
          <h3>üóÑÔ∏è Backup & Restore</h3>
          <p class="muted">Download a JSON snapshot of local data, or restore from a JSON file.</p>
          <div class="row" style="margin-top:10px">
            <button id="btnBackup" class="chip">Download Backup (JSON)</button>
            <input type="file" id="restoreFile" accept=".json" />
            <button id="btnRestore" class="chip">Restore</button>
          </div>
          <p id="backupMsg" class="muted">‚Äî</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">Admin ¬∑ Hospital ERP</footer>

  <script src="../scripts/utils.js"></script>
  <script src="../scripts/scanner.js"></script>
  <script>
    // Theme toggle
    (function(){
      const root=document.documentElement, btn=document.getElementById('themeToggle');
      const saved=localStorage.getItem('theme')||'light';
      root.dataset.theme=saved; btn.textContent=saved==='dark'?'üåô':'üåû';
      btn.onclick=()=>{ const next=root.dataset.theme==='dark'?'light':'dark';
        root.dataset.theme=next; localStorage.setItem('theme',next);
        btn.textContent=next==='dark'?'üåô':'üåû';
      };
    })();

    // Clear cache (preserve theme)
    document.getElementById('btnClear').onclick = async ()=>{
      try{ if('caches' in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); } }catch{}
      const keepTheme = localStorage.getItem('theme');
      localStorage.clear(); if(keepTheme) localStorage.setItem('theme', keepTheme);
      location.reload();
    };

    // ===== Scan to Upload Stock =====
    const scanUI = {
      box: document.getElementById('scanVideo'),
      status: document.getElementById('scanStatus'),
      name: document.getElementById('iName'),
      barcode: document.getElementById('iBarcode'),
      batch: document.getElementById('iBatch'),
      expiry: document.getElementById('iExpiry'),
      mrp: document.getElementById('iMRP'),
      gst: document.getElementById('iGST'),
      qty: document.getElementById('iQty'),
    };
    let stopScan = null;

    document.getElementById('scanStart').onclick = async ()=>{
      try{
        if (stopScan) stopScan();
        stopScan = await startScanner({
          containerId: 'scanVideo',
          onDetected: (code)=>{
            scanUI.status.textContent = 'Scanned: ' + code;
            scanUI.barcode.value = String(code).trim();
          },
          onError: (e)=> { scanUI.status.textContent = 'Scanner error: ' + e.message; }
        });
        scanUI.status.textContent = 'Scanner running‚Ä¶';
      }catch(e){
        scanUI.status.textContent = 'Start failed: ' + e.message;
      }
    };
    document.getElementById('scanStop').onclick = ()=>{ try{ stopScan && stopScan(); }catch{} stopScan=null; scanUI.status.textContent='Stopped'; };

    document.getElementById('btnSaveStock').onclick = ()=>{
      const row = {
        name: scanUI.name.value.trim(),
        barcode: scanUI.barcode.value.trim(),
        code: scanUI.barcode.value.trim(),
        batch: scanUI.batch.value.trim(),
        expiry: scanUI.expiry.value.trim(),
        mrp: Number(scanUI.mrp.value || 0),
        gst: Number(scanUI.gst.value || 0),
        qty: Number(scanUI.qty.value || 0),
      };
      if(!row.barcode){ alert('Barcode required'); return; }
      const inv = ERP.load('inventory', []);
      ERP.applyPurchaseRows(inv, [row]);
      scanUI.status.textContent = 'Saved ‚úì  (Inventory rows: ' + ERP.load('inventory',[]).length + ')';
      scanUI.qty.value = '';
    };

    // ===== CSV Import / Export =====
    document.getElementById('btnImportCSV').onclick = async ()=>{
      const f = document.getElementById('invCSVFile').files?.[0];
      if(!f) return alert('Choose a CSV file.');
      const text = await f.text();
      const count = await ERP.mergeInventoryCSVText(text);
      document.getElementById('importStatus').textContent = `Merged ${count} rows ‚úì`;
    };
    document.getElementById('btnExportInv').onclick      = ()=> ERP.downloadCSV('inventory.csv', ERP.load('inventory', []));
    document.getElementById('btnExportPatients').onclick = ()=> ERP.downloadCSV('patients.csv',  ERP.load('patients',  []));
    document.getElementById('btnExportInvoices').onclick = ()=> ERP.downloadCSV('invoices.csv',  ERP.load('invoices',  []));
    document.getElementById('btnExportInvItems').onclick = ()=> ERP.downloadCSV('invoice_items.csv', ERP.load('invoice_items', []));

    // ===== Backup / Restore =====
    document.getElementById('btnBackup').onclick = ()=>{
      const dump = {
        inventory: ERP.load('inventory', []),
        patients: ERP.load('patients', []),
        invoices: ERP.load('invoices', []),
        invoice_items: ERP.load('invoice_items', []),
        staff: ERP.load('staff', []),
      };
      const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'erp-backup-' + ERP.todayISO() + '.json';
      a.click(); URL.revokeObjectURL(a.href);
      document.getElementById('backupMsg').textContent = 'Backup downloaded ‚úì';
    };

    document.getElementById('btnRestore').onclick = async ()=>{
      const f = document.getElementById('restoreFile').files?.[0];
      if(!f) return alert('Choose a JSON backup file.');
      const text = await f.text();
      try{
        const data = JSON.parse(text);
        if (data.inventory) ERP.save('inventory', data.inventory);
        if (data.patients) ERP.save('patients', data.patients);
        if (data.invoices) ERP.save('invoices', data.invoices);
        if (data.invoice_items) ERP.save('invoice_items', data.invoice_items);
        if (data.staff) ERP.save('staff', data.staff);
        document.getElementById('backupMsg').textContent = 'Restore complete ‚úì  (reload recommended)';
      } catch(e){
        document.getElementById('backupMsg').textContent = 'Restore failed: ' + e.message;
      }
    };
  </script>
</body>
</html>
