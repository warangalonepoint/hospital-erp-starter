<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Ä¢ Hospital ERP</title>

  <!-- Correct path from /pages/ to root-level styles.css -->
  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="../manifest-icon-192.png">
</head>
<body>
  <!-- Top banner -->
  <header class="banner">
    <div class="brand">
      <span class="brand-mark">üè•</span>
      <span class="brand-title">Hospital ERP</span>
    </div>
    <button id="themeToggle" class="toggle" title="Toggle theme">üåô</button>
  </header>

  <!-- Toolbar -->
  <nav class="toolbar">
    <a class="chip" href="../index.html">‚Üê Home</a>
    <button id="btnLogout" class="chip">Logout</button>
    <button id="btnClear" class="chip">Clear Cache</button>
  </nav>

  <!-- Six main cards -->
  <main class="section cards6">
    <!-- 1. Analytics -->
    <a class="panel grad-lilac card" href="./analytics.html">
      <h2>Analytics</h2>
      <p class="muted">KPIs & weekly sales</p>
    </a>

    <!-- 2. Pharmacy -->
    <a class="panel grad-sky card" href="./pharmacy.html">
      <h2>Pharmacy</h2>
      <p class="muted">
        Today <b id="phToday">‚Çπ0.00</b> ¬∑
        MTD <b id="phMTD">‚Çπ0.00</b> ¬∑
        Top: <b id="phTop">‚Äî</b>
      </p>
    </a>

    <!-- 3. Booking Status -->
    <a class="panel grad-mint card" href="./booking-status.html">
      <h2>Booking Status</h2>
      <p class="muted">Today / Week / Month counts</p>
    </a>

    <!-- 4. Patients -->
    <a class="panel grad-rose card" href="./admin.html#patients">
      <h2>Patients</h2>
      <p class="muted">Reminders & history ‚Ä¢ <b id="dueToday">0 due today</b></p>
    </a>

    <!-- 5. Staff -->
    <a class="panel grad-peach card" href="./staff.html">
      <h2>Staff</h2>
      <p class="muted">Roster & attendance</p>
    </a>

    <!-- 6. Settings -->
    <a class="panel grad-lavender card" href="./settings.html">
      <h2>Settings</h2>
      <p class="muted">PINs, Staff, Patients</p>
    </a>
  </main>

  <!-- Scripts -->
  <script src="../utils.js"></script>
  <script>
    // Theme toggle
    (function theme() {
      const root = document.documentElement;
      const btn  = document.getElementById('themeToggle');
      const saved = localStorage.getItem('theme') || 'light';
      root.dataset.theme = saved;
      btn.textContent = saved === 'dark' ? 'üåô' : 'üåû';
      btn.onclick = () => {
        const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
        root.dataset.theme = next;
        localStorage.setItem('theme', next);
        btn.textContent = next === 'dark' ? 'üåô' : 'üåû';
      };
    })();

    // Logout / Clear cache (simple, no role checks)
    document.getElementById('btnLogout').onclick = () => {
      // keep theme; clear lightweight session keys if any
      const keepTheme = localStorage.getItem('theme');
      localStorage.clear();
      if (keepTheme) localStorage.setItem('theme', keepTheme);
      location.href = '../pages/login.html';
    };
    document.getElementById('btnClear').onclick = async () => {
      if (confirm('Clear local data & cache?')) {
        await (window.ERP?.hardClear?.() || Promise.resolve());
      }
    };

    // Optional dashboard hydration (uses utils.js if present)
    (function hydrateDashboard() {
      if (!window.ERP) return; // graceful if utils not loaded

      const invoices = ERP.load('invoices', []);
      const items    = ERP.load('invoice_items', []);
      const patients = ERP.load('patients', []);

      const todayISO = ERP.todayISO();
      const firstOfMTD = new Date(); firstOfMTD.setDate(1);
      const firstYMD = ERP.ymd(firstOfMTD);

      const invById = new Map(invoices.map(i => [String(i.id || i.invoice_id), i]));

      const invToday = invoices.filter(i => ERP.ymd(i.date || i.invoice_date) === todayISO);
      const itemsToday = items.filter(it => {
        const inv = invById.get(String(it.invoice_id));
        return inv && ERP.ymd(inv.date || inv.invoice_date) === todayISO;
      });
      const kpiToday = ERP.buildSalesKPIs(invToday, itemsToday);

      const invMTD = invoices.filter(i => {
        const d = ERP.ymd(i.date || i.invoice_date);
        return d >= firstYMD && d <= todayISO;
      });
      const itemsMTD = items.filter(it => {
        const inv = invById.get(String(it.invoice_id));
        if (!inv) return false;
        const d = ERP.ymd(inv.date || inv.invoice_date);
        return d >= firstYMD && d <= todayISO;
      });
      const kpiMTD = ERP.buildSalesKPIs(invMTD, itemsMTD);

      // Render
      document.getElementById('phToday').textContent = ERP.formatMoney(kpiToday.total);
      document.getElementById('phMTD').textContent   = ERP.formatMoney(kpiMTD.total);

      // Top item overall
      const top = ERP.topItems(items, 1)[0];
      document.getElementById('phTop').textContent = top ? (top.name || '‚Äî') : '‚Äî';

      // Patients due today by next_followup / next_visit / followup
      const due = patients.filter(p => {
        const d = p.next_followup || p.next_visit || p.followup || '';
        return d && ERP.ymd(d) === todayISO;
      }).length;
      document.getElementById('dueToday').textContent = `${due} due today`;
    })();
  </script>

  <style>
    /* small layout helper for the six cards */
    .cards6 {
      display: grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px) {
      .cards6 { grid-template-columns: 1fr 1fr; }
    }
  </style>
</body>
</html>
