<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard • Hospital ERP</title>
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="icon" href="../public/assets/icon-192.png">
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="floating-toggle" title="Toggle theme">🌙</button>
  </header>

  <!-- Top actions -->
  <div class="fixed-actions">
    <a class="chip" href="./login.html">↪ Login</a>
    <button class="chip" id="logoutBtn">Logout</button>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
  </div>

  <!-- Main navigation panels -->
  <section class="section">
    <div class="card-grid">
      <a class="card panel--lilac" href="./booking-status.html">
        <h3>Bookings</h3>
        <p>Create tokens & manage appointments</p>
      </a>
      <a class="card panel--mint" href="./pharmacy.html">
        <h3>Pharmacy – Billing</h3>
        <p>Multi-item invoices, discounts, payments</p>
      </a>
      <a class="card panel--peach" href="./pharmacy.html#reports">
        <h3>Pharmacy – Reports</h3>
        <p>Daily / Weekly / Monthly / Yearly sales & items</p>
      </a>
      <a class="card panel--rose" href="./staff.html">
        <h3>Staff – Attendance & Roster</h3>
        <p>Create day sheet, mark, edit, export</p>
      </a>
    </div>
  </section>

  <!-- Snapshot -->
  <section class="section">
    <h2 class="muted">Today Snapshot</h2>
    <div class="kpi-grid mt12">
      <div class="kpi" style="background:var(--t-blue);color:var(--c-blue)">
        <h4>Total (₹)</h4><div class="num" id="kpiTotal">0.00</div>
      </div>
      <div class="kpi" style="background:var(--t-lilac);color:var(--c-lilac)">
        <h4>Invoices</h4><div class="num" id="kpiInvoices">0</div>
      </div>
      <div class="kpi" style="background:var(--t-mint);color:var(--c-mint)">
        <h4>Paid (₹)</h4><div class="num" id="kpiPaid">0.00</div>
      </div>
      <div class="kpi" style="background:var(--t-peach);color:var(--c-peach)">
        <h4>Top Item</h4><div class="num" id="kpiTop">—</div>
      </div>
    </div>
  </section>

  <!-- Admin quick link -->
  <section class="section">
    <h2 class="muted">Admin & Setup</h2>
    <div class="chips mt12">
      <a class="chip" href="./admin.html">Open Admin</a>
      <a class="chip" href="./settings.html">Settings</a>
      <a class="chip" href="./analytics.html">Sales Analytics</a>
    </div>
  </section>

  <script src="../scripts/utils.js"></script>
  <script>
    // Theme toggle (shared)
    (function initTheme(){
      try {
        const key='erp_theme';
        const root=document.documentElement;
        const btn=document.getElementById('themeToggle');
        const saved=localStorage.getItem(key)||'light';
        root.setAttribute('data-theme', saved);
        btn.textContent = saved==='dark' ? '☀️' : '🌙';
        btn.addEventListener('click', () => {
          const now = root.getAttribute('data-theme')==='dark' ? 'light' : 'dark';
          root.setAttribute('data-theme', now);
          localStorage.setItem(key, now);
          btn.textContent = now==='dark' ? '☀️' : '🌙';
        });
      } catch(e){}
    })();

    // Logout / Clear cache (shared)
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('erp_role');
      window.location.href = './login.html';
    });
    document.getElementById('clearCacheBtn').addEventListener('click', async () => {
      if (!confirm('Clear cached data & reload?')) return;
      const keep=['erp_theme'];
      Object.keys(localStorage).forEach(k => { if(!keep.includes(k)) localStorage.removeItem(k); });
      if ('caches' in window) {
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }
      location.reload();
    });

    // Tiny snapshot from demo invoices (if utils seeded CSV to localStorage)
    (function loadSnapshot(){
      try {
        const invoices = window.erp?.getInvoices?.() || [];
        const total = invoices.reduce((s, r) => s + (+r.total || 0), 0);
        const paid  = invoices.reduce((s, r) => s + (+r.paid  || 0), 0);
        document.getElementById('kpiTotal').textContent    = total.toFixed(2);
        document.getElementById('kpiPaid').textContent     = paid.toFixed(2);
        document.getElementById('kpiInvoices').textContent = invoices.length;

        // Find top item from invoice_items if available
        const items = window.erp?.getInvoiceItems?.() || [];
        const countBy = {};
        items.forEach(it => { countBy[it.item_name] = (countBy[it.item_name]||0) + (+it.qty||0); });
        const top = Object.entries(countBy).sort((a,b)=>b[1]-a[1])[0];
        document.getElementById('kpiTop').textContent = top ? top[0] : '—';
      } catch(e){}
    })();
  </script>
</body>
</html>
