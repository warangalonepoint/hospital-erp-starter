<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • Hospital ERP</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="manifest-icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <div class="brand">
      <span class="brand-mark">🏥</span>
      <span class="brand-title">Hospital ERP</span>
    </div>
    <button id="themeToggle" class="toggle" title="Toggle theme">🌙</button>
  </header>

  <!-- Toolbar -->
  <nav class="toolbar">
    <button id="btnLogout" class="chip">Logout</button>
    <button id="btnClear" class="chip">Clear Cache</button>
  </nav>

  <!-- ===== Analytics first ===== -->
  <section class="section">
    <h2>📊 Sales Analytics</h2>
    <div class="kpi-grid">
      <div class="kpi"><div class="label">Total Sales</div><div class="value" id="kpiTotal">₹0</div></div>
      <div class="kpi"><div class="label">Items Sold</div><div class="value" id="kpiItems">0</div></div>
      <div class="kpi"><div class="label">GST</div><div class="value" id="kpiGST">₹0</div></div>
      <div class="kpi"><div class="label">Balance</div><div class="value" id="kpiBal">₹0</div></div>
    </div>
    <canvas id="revChart" style="margin-top:18px;max-height:280px"></canvas>
  </section>

  <!-- ===== Cards below ===== -->
  <main class="grid-cards">
    <a class="card grad-purple" href="analytics.html">
      <h2>Analytics</h2><p>KPIs & weekly sales</p>
    </a>

    <a class="card grad-sky" href="pharmacy.html">
      <h2>Pharmacy</h2><p>Billing & Inventory</p>
    </a>

    <a class="card grad-mint" href="booking-status.html">
      <h2>Booking Status</h2><p>Today / Week / Month</p>
    </a>

    <a class="card grad-rose" href="patients.html">
      <h2>Patients</h2><p>Reminders & history</p>
    </a>

    <a class="card grad-peach" href="staff.html">
      <h2>Staff</h2><p>Roster & attendance</p>
    </a>

    <a class="card grad-lavender" href="settings.html">
      <h2>Settings</h2><p>PINs, Staff, Patients</p>
    </a>
  </main>

  <footer class="footer">Dashboard · Hospital ERP</footer>

  <script src="utils.js"></script>
  <script>
    // Theme
    (function(){
      const root=document.documentElement, btn=document.getElementById('themeToggle');
      const saved=localStorage.getItem('theme')||'light';
      root.dataset.theme=saved; btn.textContent=saved==='dark'?'🌙':'🌞';
      btn.onclick=()=>{ const next=root.dataset.theme==='dark'?'light':'dark';
        root.dataset.theme=next; localStorage.setItem('theme',next);
        btn.textContent=next==='dark'?'🌙':'🌞';
      };
    })();

    // Toolbar
    btnLogout.onclick=()=>{ localStorage.clear(); sessionStorage.clear(); location.href='login.html'; };
    btnClear.onclick=async()=>{ localStorage.clear(); sessionStorage.clear();
      if('caches'in window){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); }
      location.reload();
    };

    // Analytics hydrate
    (function(){
      const invoices = ERP.load('invoices', []);
      const items    = ERP.load('invoice_items', []);
      const kpi      = ERP.buildSalesKPIs(invoices, items);
      document.getElementById('kpiTotal').textContent = ERP.formatMoney(kpi.total);
      document.getElementById('kpiItems').textContent = kpi.itemsSold;
      document.getElementById('kpiGST').textContent   = ERP.formatMoney(kpi.gst);
      document.getElementById('kpiBal').textContent   = ERP.formatMoney(kpi.balance);

      const invById = new Map(invoices.map(i => [String(i.id||i.invoice_id), i]));
      const daily   = ERP.dailyRevenue(items, invById);
      new Chart(document.getElementById('revChart'),{
        type:'line',
        data:{ labels: daily.map(r=>r.date),
               datasets:[{ label:'Revenue', data: daily.map(r=>r.amount), borderColor:'#2563eb', tension:.35, pointRadius:2 }]},
        options:{ responsive:true, plugins:{ legend:{display:false}},
                  scales:{ y:{ ticks:{ callback:v=>'₹ '+v }}}}
      });
    })();
  </script>
</body>
</html>
