<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Dashboard</title>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=30"/>
  <style>
    .section{margin:12px}
    .tint{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
    .tint-blue{background: color-mix(in srgb, #2563eb 16%, var(--card-bg))}
    .tint-mint{background: color-mix(in srgb, #22c55e 14%, var(--card-bg))}
    .tint-peach{background: color-mix(in srgb, #fb923c 14%, var(--card-bg))}
    .kpi-grid{display:grid;gap:14px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:760px){.kpi-grid{grid-template-columns:1fr}}
    .kpi .num{font-size:32px;font-weight:800}
    .card{border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
    .chip{height:40px;padding:0 14px;border-radius:999px;background:var(--card-bg);border:1px solid rgba(0,0,0,.06)}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:980px){.grid-3{grid-template-columns:1fr}}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header class="banner">
    <button id="themeToggle" class="chip floating-toggle" aria-label="Theme">üåô</button>
  </header>

  <nav class="fixed-actions">
    <a class="chip" href="login.html">‚Üê Roles</a>
    <a class="chip" href="booking-status.html">Bookings (Doctor)</a>
    <a class="chip" href="pharmacy.html">Pharmacy</a>
    <span id="whoami" class="chip" style="pointer-events:none">Role: Guest</span>
    <button id="logoutBtn" class="chip">Logout</button>
    <button id="clearCacheBtn" class="chip">Clear Cache</button>
  </nav>

  <section class="section">
    <div class="kpi-grid">
      <div class="tint tint-blue">
        <h4>Patients Today</h4>
        <div class="num" id="kToday">0</div>
        <div class="muted" id="lblToday"></div>
      </div>
      <div class="tint tint-mint">
        <h4>This Month</h4>
        <div class="num" id="kMonth">0</div>
        <div class="muted" id="lblMonth"></div>
      </div>
      <div class="tint tint-peach">
        <h4>YTD</h4>
        <div class="num" id="kYTD">0</div>
        <div class="muted" id="lblYTD"></div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="grid grid-3">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Appointments</h2>
        <div class="muted">Review bookings and write prescriptions.</div>
        <div style="margin-top:10px"><a class="chip" href="booking-status.html">Open</a></div>
      </div>
      <div class="card">
        <h2 style="margin:0 0 8px 0">Pharmacy</h2>
        <div class="muted">Sell, stock, reports (PWA-ready).</div>
        <div style="margin-top:10px"><a class="chip" href="pharmacy.html">Open</a></div>
      </div>
      <div class="card">
        <h2 style="margin:0 0 8px 0">Settings</h2>
        <div class="muted">Preferences & clinic info.</div>
        <div style="margin-top:10px"><a class="chip" href="settings.html">Open</a></div>
      </div>
    </div>
  </section>

  <script type="module">
    // Theme
    const tt=document.getElementById('themeToggle');
    if(localStorage.theme){document.documentElement.dataset.theme=localStorage.theme;tt.textContent=localStorage.theme==='light'?'üåû':'üåô'}
    tt.onclick=()=>{const cur=document.documentElement.dataset.theme||'light';const nxt=cur==='light'?'dark':'light';document.documentElement.dataset.theme=nxt;localStorage.theme=nxt;tt.textContent=nxt==='light'?'üåû':'üåô'}

    // Role badge / actions
    const who=document.getElementById('whoami');
    const ses=JSON.parse(localStorage.getItem('session')||'{}');
    if(who) who.textContent = ses.role ? `Role: ${ses.role}` : 'Role: Guest';
    logoutBtn.onclick=()=>{localStorage.removeItem('session');location.href='login.html'}
    clearCacheBtn.onclick=async()=>{localStorage.clear();if('caches'in window){const ks=await caches.keys();await Promise.all(ks.map(c=>caches.delete(c)))};location.reload()}

    // KPIs from bookings store
    const bookings=()=>JSON.parse(localStorage.getItem('bookings')||'[]');
    const ISO=d=>new Date(d).toISOString().slice(0,10);
    const today=ISO(new Date());
    const monthStart=ISO(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
    const ytdStart=ISO(new Date(new Date().getFullYear(), 0, 1));
    const inRange=(iso,a,b)=> iso>=a && iso<=b;

    function computeKPIs(){
      const all=bookings();
      const t=all.filter(b=>b.date===today).length;
      const m=all.filter(b=>inRange(b.date, monthStart, today)).length;
      const y=all.filter(b=>inRange(b.date, ytdStart, today)).length;
      kToday.textContent=t;   lblToday.textContent=today;
      kMonth.textContent=m;   lblMonth.textContent=`${monthStart} ‚Üí ${today}`;
      kYTD.textContent=y;     lblYTD.textContent=`${ytdStart} ‚Üí ${today}`;
    }
    computeKPIs();

    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}) }
  </script>
</body>
</html>
