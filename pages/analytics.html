<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analytics ¬∑ Reports</title>
  <link rel="stylesheet" href="../styles/styles.css" />
</head>
<body>
  <header class="app-topbar">
    <nav class="nav">
      <a class="link-back" href="./dashboard.html">‚Üê Dashboard</a>
      <div class="spacer"></div>
      <button class="pill" id="themeToggle">üåó</button>
    </nav>
  </header>

  <main class="container">
    <section class="panel">
      <div class="panel-head">
        <h2>Sales Reports</h2>
        <div class="segmented" id="rangeCtl">
          <button class="seg active" data-range="7d">Last 7D</button>
          <button class="seg" data-range="30d">Last 30D</button>
          <button class="seg" data-range="mtd">MTD</button>
          <button class="seg" data-range="ytd">YTD</button>
        </div>
      </div>

      <!-- NEW: date range filters -->
      <div class="controls" style="margin-top:.6rem">
        <label>From&nbsp;<input class="input" type="date" id="fromDate"></label>
        <label>To&nbsp;<input class="input" type="date" id="toDate"></label>
        <button class="btn" id="applyRange">Apply</button>
      </div>

      <div class="kpi-row" style="margin-top:.6rem">
        <div class="kpi gradient-sky"><span>Total (‚Çπ)</span><strong id="kpiTotal">0.00</strong></div>
        <div class="kpi gradient-purple"><span>Avg / Day (‚Çπ)</span><strong id="kpiAvg">0.00</strong></div>
        <div class="kpi gradient-green"><span>Invoices</span><strong id="kpiInvoices">0</strong></div>
        <div class="kpi gradient-slate"><span>Top Item</span><strong id="kpiTop">‚Äî</strong></div>
        <div class="kpi gradient-lavender"><span>Items Sold</span><strong id="kpiQty">0</strong></div>
      </div>

      <div class="chart-block"><h4>Revenue by Day</h4><div class="chart-placeholder" id="revChart"></div></div>
      <div class="chart-block"><h4>Top Items</h4><div class="chart-placeholder" id="topChart"></div></div>

      <div class="panel" style="margin-top:1rem">
        <h3>Download</h3>
        <div class="controls">
          <button class="btn" id="btnExportSales">Export Sales (CSV)</button>
          <button class="btn" id="btnExportItems">Export Items (CSV)</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">Analytics ¬∑ Hospital ERP</footer>

  <script type="module">
    import {fetchCSV, renderBars, sumBy, formatINR, downloadCSV} from '../scripts/utils.js';

    // theme
    const root = document.documentElement;
    const saved = localStorage.getItem('theme');
    if (saved) root.setAttribute('data-theme', saved);
    else if (window.matchMedia('(prefers-color-scheme: light)').matches) root.setAttribute('data-theme','light');
    document.getElementById('themeToggle').onclick = () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next); localStorage.setItem('theme', next);
    };

    // elements
    const fromEl = document.getElementById('fromDate');
    const toEl   = document.getElementById('toDate');
    const apply  = document.getElementById('applyRange');

    // helper dates
    function parseD(s){ return new Date(s.replace(/-/g,'/')); }
    function fmtDate(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function clampDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }

    // preset buttons
    document.querySelectorAll('#rangeCtl .seg').forEach(b=>{
      b.addEventListener('click', ()=> {
        document.querySelectorAll('#rangeCtl .seg').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        setPreset(b.dataset.range);
      });
    });

    // init default (last 7 days)
    setPreset('7d');

    // Apply custom date range
    apply.addEventListener('click', ()=>{
      const f = fromEl.value, t = toEl.value;
      if (!f || !t) return alert('Pick both From and To dates');
      const from = clampDay(new Date(f));
      const to   = clampDay(new Date(t));
      if (to < from) return alert('To date cannot be earlier than From date');
      // clear preset highlight
      document.querySelectorAll('#rangeCtl .seg').forEach(x=>x.classList.remove('active'));
      load(from, to);
    });

    // state for export
    let lastSales = []; let lastItems = [];

    async function load(from, to) {
      const inv   = await fetchCSV('../data/invoices.csv');
      const items = await fetchCSV('../data/invoice_items.csv');

      // filter rows by date range (inclusive)
      const sales = inv.filter(r=>{
        const d = clampDay(parseD(r.date));
        return d >= from && d <= to;
      });

      // items under those invoices
      const idSet = new Set(sales.map(r=>r.invoice_id));
      const itemRows = items.filter(it=> idSet.has(it.invoice_id));

      // KPIs
      const total = sales.reduce((a,b)=> a + Number(b.total||0), 0);
      const days  = Math.max(1, Math.round((to - from)/86400000) + 1);
      document.getElementById('kpiTotal').textContent    = formatINR(total);
      document.getElementById('kpiAvg').textContent      = formatINR(total/days);
      document.getElementById('kpiInvoices').textContent = String(sales.length);
      const qty = itemRows.reduce((a,b)=> a + Number(b.qty||0), 0);
      document.getElementById('kpiQty').textContent = String(qty);

      // top item by value
      const byItem = sumBy(itemRows, it=>it.item, it=> Number(it.qty||0) * Number(it.price||0));
      let top='‚Äî', topVal=0; for (const [k,v] of byItem.entries()) if (v>topVal){ top=k; topVal=v; }
      document.getElementById('kpiTop').textContent = top || '‚Äî';

      // charts
      const map = sumBy(sales, r=>r.date, r=>r.total);
      const series=[]; const cur = new Date(from);
      while (cur <= to) {
        const key = fmtDate(cur);
        series.push({label:key, value:Number(map.get(key)||0)});
        cur.setDate(cur.getDate()+1);
      }
      renderBars(document.getElementById('revChart'), series, {});
      const topSeries = Array.from(byItem.entries()).map(([label,value])=>({label,value}))
                        .sort((a,b)=>b.value-a.value).slice(0,8);
      renderBars(document.getElementById('topChart'), topSeries, {});

      // exports
      lastSales = sales;
      lastItems = itemRows.map(r=>({
        invoice_id: r.invoice_id,
        item: r.item,
        qty: r.qty,
        price: r.price,
        total: (Number(r.qty||0)*Number(r.price||0)).toFixed(2)
      }));
    }

    // presets set the date inputs + call load()
    function setPreset(preset){
      const today = clampDay(new Date());
      let from = new Date(today), to = new Date(today);
      if (preset==='7d')  from.setDate(today.getDate()-6);
      if (preset==='30d') from.setDate(today.getDate()-29);
      if (preset==='mtd') from = new Date(today.getFullYear(), today.getMonth(), 1);
      if (preset==='ytd') from = new Date(today.getFullYear(), 0, 1);
      fromEl.value = fmtDate(from);
      toEl.value   = fmtDate(to);
      load(from, to);
    }

    // export buttons
    document.getElementById('btnExportSales').onclick = ()=> downloadCSV(`sales-${new Date().toISOString().slice(0,10)}.csv`, lastSales);
    document.getElementById('btnExportItems').onclick = ()=> downloadCSV(`items-${new Date().toISOString().slice(0,10)}.csv`, lastItems);
  </script>
</body>
</html>
