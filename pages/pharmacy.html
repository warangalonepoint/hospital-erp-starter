<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy ‚Ä¢ Hospital ERP</title>
  <link rel="stylesheet" href="../styles/styles.css" />
  <script defer src="../scripts/utils.js"></script>
  <script defer src="../scripts/scanner.js"></script>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button class="toggle" id="themeToggle" title="Toggle theme">üåô</button>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <a class="chip" href="../index.html">‚Üê Dashboard</a>
    <button class="chip" id="clearCacheBtn">Clear Cache</button>
    <div style="flex:1"></div>
    <div class="row">
      <button class="chip chip--primary" data-tab="sell">Sell</button>
      <button class="chip" data-tab="purchase">Purchase</button>
      <button class="chip" data-tab="stock">Stock</button>
      <button class="chip" data-tab="reports">Reports</button>
    </div>
  </div>

  <!-- SELL -->
  <section class="section" id="tab-sell">
    <div class="panel grad-lilac">
      <h2>Quick POS</h2>
      <p class="muted">Search or scan items, link a patient by barcode, and create a bill.</p>
    </div>

    <div class="grid-2" style="margin-top:12px">
      <!-- Left: Cart -->
      <div class="section">
        <h3 style="margin:0 0 8px">Patient Link</h3>
        <div class="row">
          <button class="chip chip--primary" id="scanPatientBtn">üì∑ Scan Patient ID</button>
          <button class="chip" id="newPatientBtn">New Patient ID</button>
        </div>
        <p id="linkedPatient" class="muted" style="margin-top:8px">No patient linked</p>

        <div class="row" style="margin-top:14px">
          <input id="searchItem" placeholder="Search item name or scan‚Ä¶" />
          <button id="scanItemBtn" class="btn">üì∑ Scan Item</button>
          <button id="loadDemoBtn" class="chip">Load Demo</button>
        </div>

        <div style="margin-top:14px; overflow:auto">
          <table class="table" id="cartTable">
            <thead>
              <tr>
                <th>Item</th><th>Batch</th><th>Qty</th><th>MRP</th><th>GST%</th><th>Line</th><th></th>
              </tr>
            </thead>
            <tbody id="cartBody"><tr><td class="muted" colspan="7">Cart is empty</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Right: Customer + Summary -->
      <div class="section">
        <h3 style="margin:0 0 8px">Customer</h3>
        <input id="custName" placeholder="Customer name (optional)" style="margin-bottom:10px" />
        <input id="custPhone" placeholder="Phone (optional)" />

        <div class="kpi-grid" style="margin-top:14px">
          <div class="kpi grad-sky">
            <div class="label">Subtotal</div>
            <div class="num" id="kSub">0.00</div>
          </div>
          <div class="kpi grad-mint">
            <div class="label">GST</div>
            <div class="num" id="kGst">0.00</div>
          </div>
          <div class="kpi grad-rose">
            <div class="label">Discount</div>
            <div class="num" id="kDisc">0.00</div>
          </div>
          <div class="kpi grad-amber">
            <div class="label">Total</div>
            <div class="num" id="kTotal">0.00</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <input id="discount" type="number" min="0" step="0.01" placeholder="Discount (‚Çπ)" style="max-width:180px"/>
          <select id="payMode" style="max-width:180px">
            <option value="cash">Cash</option>
            <option value="upi">UPI</option>
            <option value="card">Card</option>
          </select>
          <div style="flex:1"></div>
          <button class="btn" id="saveBillBtn">Save & Print</button>
        </div>
      </div>
    </div>
  </section>

  <!-- PURCHASE -->
  <section class="section" id="tab-purchase" hidden>
    <div class="panel grad-mint">
      <h2>Purchase</h2>
      <p class="muted">Add supplier invoice. Updates <strong>batch</strong>, <strong>expiry</strong>, cost & stock.</p>
    </div>
    <div class="grid-2" style="margin-top:12px">
      <div class="section">
        <div class="row">
          <input id="supName" placeholder="Supplier / Party" style="max-width:260px">
          <input id="billNo" placeholder="Supplier Bill No." style="max-width:200px">
          <input id="billDate" type="date" style="max-width:180px">
          <div style="flex:1"></div>
          <button class="btn" id="addRowBtn">+ Add Item</button>
        </div>
        <div style="margin-top:12px; overflow:auto">
          <table class="table" id="purTable">
            <thead>
              <tr>
                <th>Item</th><th>Batch</th><th>Expiry</th><th>Qty</th><th>Cost</th><th>MRP</th><th>GST%</th><th></th>
              </tr>
            </thead>
            <tbody id="purBody"><tr><td class="muted" colspan="8">No items</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="section">
        <div class="kpi-grid">
          <div class="kpi grad-sky"><div class="label">Items</div><div class="num" id="pItems">0</div></div>
          <div class="kpi grad-amber"><div class="label">Gross</div><div class="num" id="pGross">0.00</div></div>
          <div class="kpi grad-rose"><div class="label">GST</div><div class="num" id="pGST">0.00</div></div>
          <div class="kpi grad-mint"><div class="label">Total</div><div class="num" id="pTotal">0.00</div></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="savePurchaseBtn">Save Purchase</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STOCK -->
  <section class="section" id="tab-stock" hidden>
    <div class="panel grad-sky">
      <h2>Stock</h2>
      <p class="muted">Current stock, expiry & near-expiry, and re-order list.</p>
    </div>
    <div class="row" style="margin-top:12px">
      <input id="stockSearch" placeholder="Search item / batch‚Ä¶" style="max-width:320px">
      <select id="stockFilter" style="max-width:220px">
        <option value="all">All</option>
        <option value="near">Near Expiry (‚â§60d)</option>
        <option value="expired">Expired</option>
        <option value="low">Below Min Qty</option>
      </select>
      <div style="flex:1"></div>
      <button class="chip" id="exportStock">‚Üì Export CSV</button>
    </div>
    <div style="margin-top:12px; overflow:auto">
      <table class="table" id="stockTable">
        <thead>
          <tr>
            <th>Item</th><th>Batch</th><th>Expiry</th><th>Qty</th><th>MRP</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="stockBody"><tr><td class="muted" colspan="6">No rows</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- REPORTS -->
  <section class="section" id="tab-reports" hidden>
    <div class="panel grad-rose">
      <h2>Pharmacy Reports</h2>
      <p class="muted">Daily / MTD / Custom Sales, Purchases, Profit, Top Items. Export CSV.</p>
    </div>

    <div class="row" style="margin-top:12px">
      <input type="date" id="rFrom" style="max-width:180px">
      <input type="date" id="rTo" style="max-width:180px">
      <button class="chip chip--primary" id="runRpt">Run</button>
      <button class="chip" data-q="today">Today</button>
      <button class="chip" data-q="7d">Last 7D</button>
      <button class="chip" data-q="30d">Last 30D</button>
      <button class="chip" data-q="mtd">MTD</button>
      <div style="flex:1"></div>
      <button class="chip" id="exportRpt">‚Üì Export CSV</button>
    </div>

    <div class="kpi-grid" style="margin-top:12px">
      <div class="kpi grad-sky"><div class="label">Total (‚Çπ)</div><div class="num" id="rtTotal">0.00</div></div>
      <div class="kpi grad-lilac"><div class="label">Avg / Day (‚Çπ)</div><div class="num" id="rtAvg">0.00</div></div>
      <div class="kpi grad-mint"><div class="label">Invoices</div><div class="num" id="rtInv">0</div></div>
      <div class="kpi grad-rose"><div class="label">Top Item</div><div class="num" id="rtTop">‚Äî</div></div>
    </div>

    <div class="section" style="margin-top:12px">
      <table class="table" id="rTable">
        <thead><tr><th>Date</th><th>Invoice</th><th>Items</th><th>Subtotal</th><th>GST</th><th>Total</th></tr></thead>
        <tbody id="rBody"><tr><td class="muted" colspan="6">No data</td></tr></tbody>
      </table>
    </div>
  </section>

  <div class="spacer"></div>

  <script>
    // Theme toggle (shared)
    const html = document.documentElement;
    const btnTheme = document.getElementById('themeToggle');
    function syncIcon(){ btnTheme.textContent = html.dataset.theme==='dark' ? 'üåô' : 'üåû'; }
    btnTheme.onclick = ()=>{ html.dataset.theme = (html.dataset.theme==='dark'?'light':'dark'); localStorage.setItem('theme', html.dataset.theme); syncIcon(); };
    html.dataset.theme = localStorage.getItem('theme') || 'dark'; syncIcon();

    // Tabs
    const tabButtons = document.querySelectorAll('[data-tab]');
    const tabs = { sell: '#tab-sell', purchase: '#tab-purchase', stock: '#tab-stock', reports: '#tab-reports' };
    tabButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        tabButtons.forEach(x=>x.classList.remove('chip--primary'));
        b.classList.add('chip--primary');
        for(const k in tabs) document.querySelector(tabs[k]).hidden = true;
        document.querySelector(tabs[b.dataset.tab]).hidden = false;
      });
    });
    // default tab
    document.querySelector('[data-tab="sell"]').click();

    // Clear cache button
    document.getElementById('clearCacheBtn')?.addEventListener('click', ()=>{
      localStorage.clear(); caches?.keys?.().then(keys=>keys.forEach(k=>caches.delete(k))); alert('Cache cleared');
    });

    // VERY SMALL demo hooks (uses utils.js functions if present)
    document.getElementById('loadDemoBtn')?.addEventListener('click', ()=>{
      alert('Demo items can be wired to inventory.csv via utils.js (loadInventory ‚Üí addToCart).');
    });
  </script>
</body>
</html>
