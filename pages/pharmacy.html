<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pharmacy ‚Ä¢ Hospital ERP</title>
  <link rel="stylesheet" href="../styles/styles.css" />
  <link rel="icon" href="../public/assets/icon-192.png" />
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <button id="themeToggle" class="toggle" title="Toggle theme">üåô</button>
  </header>

  <!-- Tabs + actions -->
  <div class="toolbar">
    <a class="chip" href="./dashboard.html">‚Üê Dashboard</a>
    <button class="chip" id="btnClear">Clear Cache</button>
    <div style="flex:1"></div>
    <button class="chip chip--primary" data-tab="sell">Sell</button>
    <button class="chip" data-tab="purchase">Purchase</button>
    <button class="chip" data-tab="stock">Stock</button>
    <button class="chip" data-tab="reports">Reports</button>
  </div>

  <!-- SELL -->
  <section class="section" id="tab-sell">
    <div class="panel grad-lilac">
      <h2>Quick POS</h2>
      <p class="muted">Search / scan, link patient, and bill.</p>
    </div>

    <div class="grid-2 mt12">
      <div class="section">
        <h3 style="margin:0 0 8px">Patient</h3>
        <div class="row">
          <button class="chip chip--primary" id="btnScanPatient">üì∑ Scan Patient ID</button>
          <button class="chip" id="btnNewPatient">New ID</button>
          <span id="patientStatus" class="muted">No patient linked</span>
        </div>

        <div class="row" style="margin-top:12px">
          <input id="item-search" placeholder="Search item or scan‚Ä¶" />
          <button id="btn-scan-item" class="btn">üì∑ Scan Item</button>
          <button id="btnDemo" class="chip">Load Demo</button>
        </div>

        <div style="margin-top:12px; overflow:auto">
          <table class="table">
            <thead>
              <tr><th>Item</th><th>Batch</th><th>Qty</th><th>MRP</th><th>GST</th><th>Line</th><th></th></tr>
            </thead>
            <tbody id="cart-body">
              <tr><td class="muted" colspan="7">Cart is empty</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px">Summary</h3>
        <div class="kpi-grid">
          <div class="kpi grad-sky"><div class="label">Items</div><div class="num" id="sum-items">0</div></div>
          <div class="kpi grad-mint"><div class="label">Subtotal</div><div class="num" id="sum-subtotal">0.00</div></div>
          <div class="kpi grad-rose"><div class="label">GST</div><div class="num" id="sum-gst">0.00</div></div>
          <div class="kpi grad-amber"><div class="label">Total</div><div class="num" id="sum-grand">0.00</div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <input id="discount" type="number" step="0.01" placeholder="Discount (‚Çπ)" style="max-width:180px">
          <select id="payMode" style="max-width:160px">
            <option value="cash">Cash</option>
            <option value="upi">UPI</option>
            <option value="card">Card</option>
          </select>
          <div style="flex:1"></div>
          <button class="btn" id="btnSave">Save & Print</button>
        </div>
      </div>
    </div>
  </section>

  <!-- PURCHASE -->
  <section class="section" id="tab-purchase" hidden>
    <div class="panel grad-mint">
      <h2>Purchase / Stock-in</h2>
      <p class="muted">Adds to inventory (batch, expiry, qty, cost/MRP).</p>
    </div>

    <div class="section mt12">
      <div class="row">
        <input id="purName" placeholder="Item name" style="max-width:260px">
        <input id="purCode" placeholder="Barcode / Code" style="max-width:200px">
        <input id="purBatch" placeholder="Batch" style="max-width:160px">
        <input id="purExpiry" placeholder="YYYY-MM" style="max-width:140px">
        <input id="purQty" type="number" step="1" placeholder="Qty" style="max-width:120px">
        <input id="purMRP" type="number" step="0.01" placeholder="MRP" style="max-width:140px">
        <input id="purGST" type="number" step="0.01" placeholder="GST%" style="max-width:120px">
        <button id="btnAddPurchase" class="btn">Add</button>
      </div>
      <p class="muted" id="purMsg" style="margin-top:10px">‚Äî</p>
    </div>
  </section>

  <!-- STOCK -->
  <section class="section" id="tab-stock" hidden>
    <div class="panel grad-sky">
      <h2>Stock</h2>
      <p class="muted">Near-expiry, expired, re-order.</p>
    </div>

    <div class="row mt12">
      <input id="stockSearch" placeholder="Search item/batch‚Ä¶" style="max-width:300px">
      <select id="stockFilter" style="max-width:220px">
        <option value="all">All</option>
        <option value="near">Near Expiry (‚â§60d)</option>
        <option value="expired">Expired</option>
        <option value="low">Below Min Qty</option>
      </select>
      <div style="flex:1"></div>
      <button id="btnExportStock" class="chip">‚Üì Export CSV</button>
    </div>

    <div style="margin-top:12px; overflow:auto">
      <table class="table">
        <thead><tr><th>Item</th><th>Batch</th><th>Expiry</th><th>Qty</th><th>MRP</th><th>Status</th></tr></thead>
        <tbody id="stockBody"><tr><td class="muted" colspan="6">Loading‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- REPORTS -->
  <section class="section" id="tab-reports" hidden>
    <div class="panel grad-rose">
      <h2>Pharmacy Reports</h2>
      <p class="muted">Totals, invoices, and top items for a date range.</p>
    </div>

    <div class="row mt12">
      <input type="date" id="repFrom" style="max-width:180px">
      <input type="date" id="repTo" style="max-width:180px">
      <button id="btnRunReports" class="chip chip--primary">Run</button>
      <button class="chip" data-q="today">Today</button>
      <button class="chip" data-q="7d">Last 7D</button>
      <button class="chip" data-q="30d">Last 30D</button>
      <button class="chip" data-q="mtd">MTD</button>
      <div style="flex:1"></div>
      <button id="btnExportSales" class="chip">‚Üì Export CSV</button>
    </div>

    <div class="kpi-grid mt12">
      <div class="kpi grad-sky"><div class="label">Total (‚Çπ)</div><div class="num" id="rpTotal">0.00</div></div>
      <div class="kpi grad-lilac"><div class="label">Avg/Day (‚Çπ)</div><div class="num" id="rpAvg">0.00</div></div>
      <div class="kpi grad-mint"><div class="label">Invoices</div><div class="num" id="rpInv">0</div></div>
      <div class="kpi grad-amber"><div class="label">Paid (‚Çπ)</div><div class="num" id="rpPaid">0.00</div></div>
    </div>

    <div class="section mt12">
      <h3 style="margin:0 0 8px">Top Items</h3>
      <table class="table" id="topItemsTbl">
        <thead><tr><th>Item</th><th>Qty</th><th>Amount</th></tr></thead>
        <tbody id="topItemsBody"><tr><td class="muted" colspan="3">‚Äî</td></tr></tbody>
      </table>
    </div>
  </section>

  <script src="../scripts/utils.js"></script>
  <script src="../scripts/scanner.js"></script>
  <script>
    // Theme
    (function(){
      const key='theme', root=document.documentElement, btn=document.getElementById('themeToggle');
      const saved=localStorage.getItem(key)||'light'; root.dataset.theme=saved; btn.textContent=saved==='dark'?'üåô':'üåû';
      btn.onclick=()=>{ const next=root.dataset.theme==='dark'?'light':'dark'; root.dataset.theme=next; localStorage.setItem(key,next); btn.textContent=next==='dark'?'üåô':'üåû'; };
    })();

    // Tabs
    const tabBtns=[...document.querySelectorAll('[data-tab]')];
    const tabs={ sell:'#tab-sell', purchase:'#tab-purchase', stock:'#tab-stock', reports:'#tab-reports' };
    tabBtns.forEach(b=> b.onclick=()=>{
      tabBtns.forEach(x=>x.classList.remove('chip--primary'));
      b.classList.add('chip--primary');
      Object.values(tabs).forEach(sel=> document.querySelector(sel).hidden = true);
      document.querySelector(tabs[b.dataset.tab]).hidden = false;
    });
    document.querySelector('[data-tab="sell"]').click();

    // Clear cache
    document.getElementById('btnClear').onclick = async ()=>{
      const keep=['theme'];
      Object.keys(localStorage).forEach(k=>{ if(!keep.includes(k)) localStorage.removeItem(k); });
      if('caches' in window){ const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
      alert('Cleared.');
    };

    // ===== Data bootstrap (optional CSV -> local cache) =====
    // If you want to pre-load CSVs into LS on first visit:
    (async function seed(){
      if(!ERP.load('inventory').length){
        try{ await ERP.loadAllCSVs(); }catch(e){}
      }
      renderStock('all');
    })();

    // ===== SELL =====
    let CART = [];
    const ids = { itemsId:'sum-items', subtotalId:'sum-subtotal', gstId:'sum-gst', discountId:'sum-discount', totalId:'sum-grand' };

    function renderCartTable(){
      const body = document.getElementById('cart-body');
      if(!CART.length){ body.innerHTML='<tr><td class="muted" colspan="7">Cart is empty</td></tr>'; }
      else{
        body.innerHTML = CART.map((it,i)=>{
          const rate = Number(it.rate ?? it.mrp)||0;
          const line = (Number(it.qty||1)*rate).toFixed(2);
          const gstAmt = (Number(it.qty||1)*rate*(Number(it.gst||0)/100)).toFixed(2);
          return `<tr data-i="${i}">
            <td>${it.name||''}</td>
            <td>${it.batch||''}</td>
            <td><input class="qty" type="number" min="1" value="${it.qty||1}" style="width:80px"></td>
            <td>‚Çπ ${rate.toFixed(2)}</td>
            <td>‚Çπ ${gstAmt}</td>
            <td>‚Çπ ${(Number(line)+Number(gstAmt)).toFixed(2)}</td>
            <td><button class="chip remove">‚úï</button></td>
          </tr>`;
        }).join('');
      }
      recalcTotals();
    }

    function recalcTotals(){
      const discount = Number(document.getElementById('discount').value||0);
      const t = ERP.calcCartTotals(CART, { discount });
      ERP.renderCartTotals(t, ids);
    }

    // qty & remove handlers
    document.getElementById('cart-body').addEventListener('input', (e)=>{
      if(e.target.classList.contains('qty')){
        const i = Number(e.target.closest('tr').dataset.i);
        CART[i].qty = Math.max(1, Number(e.target.value||1));
        recalcTotals(); renderCartTable();
      }
    });
    document.getElementById('cart-body').addEventListener('click', (e)=>{
      if(e.target.classList.contains('remove')){
        const i = Number(e.target.closest('tr').dataset.i);
        CART.splice(i,1); renderCartTable();
      }
    });
    document.getElementById('discount').addEventListener('input', recalcTotals);

    // search add
    document.getElementById('item-search').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        const term = e.target.value.trim().toLowerCase();
        const inv = ERP.load('inventory', []);
        const idx = ERP.indexInventory(inv);
        const hit = idx.byBarcode.get(term) || idx.byName.get(term);
        if(!hit) return alert('Not found in inventory');
        CART = ERP.addToCart(CART, { code: hit.barcode||hit.code||'', name: hit.name, batch: hit.batch, qty:1, mrp:Number(hit.mrp||0), gst:Number(hit.gst||0) });
        renderCartTable(); e.target.value='';
      }
    });

    // scanner add (item)
    document.getElementById('btn-scan-item').onclick = async ()=>{
      if(typeof window.startScanner!=='function' && !(window.Scanner?.start)){ alert('Scanner not available.'); return; }
      const stop = await (window.startScanner ? startScanner({
        containerId:'scan-overlay',
        modal:true,
        onDetected: (code)=>{
          const inv = ERP.load('inventory', []);
          const idx = ERP.indexInventory(inv);
          const hit = idx.byBarcode.get(String(code).trim().toLowerCase());
          if(hit){ CART = ERP.addToCart(CART, { code: hit.barcode||hit.code||'', name: hit.name, batch: hit.batch, qty:1, mrp:Number(hit.mrp||0), gst:Number(hit.gst||0) }); renderCartTable(); }
        }
      }) : window.Scanner.start({ containerId:'scan-overlay', onDecode:(code)=>{/* same as above */} }));
      // stop() can be called on modal close if your scanner supports it
    };

    // demo
    document.getElementById('btnDemo').onclick = ()=>{
      const inv = ERP.load('inventory', []);
      CART = [];
      inv.slice(0,3).forEach(x=>{
        CART = ERP.addToCart(CART, { code:x.barcode||x.code||'', name:x.name, batch:x.batch, qty:1, mrp:Number(x.mrp||0), gst:Number(x.gst||0) });
      });
      renderCartTable();
    };

    // patient link (basic)
    let LINKED=null;
    document.getElementById('btnNewPatient').onclick=()=>{
      const id='P'+Date.now().toString().slice(-6);
      LINKED={ patient_id:id, name:'New Patient' };
      document.getElementById('patientStatus').textContent = `Linked: ${id} (new)`;
    };
    document.getElementById('btnScanPatient').onclick=async ()=>{
      if(typeof window.startScanner!=='function' && !(window.Scanner?.start)){ alert('Scanner not available.'); return; }
      const stop = await (window.startScanner ? startScanner({
        containerId:'scan-overlay',
        modal:true,
        onDetected:(code)=>{
          const pats = ERP.load('patients', []);
          const p = pats.find(r => String(r.patient_id)===String(code));
          if(!p) return alert('Patient not found');
          LINKED = p;
          document.getElementById('patientStatus').textContent = `Linked: ${p.name} (${p.patient_id})`;
        }
      }) : window.Scanner.start({ containerId:'scan-overlay', onDecode:(code)=>{/* same */} }));
    };

    // Save (demo)
    document.getElementById('btnSave').onclick = ()=>{
      if(!CART.length) return alert('Cart empty');
      const totals = ERP.calcCartTotals(CART, { discount: Number(document.getElementById('discount').value||0) });
      const invId = 'INV'+Date.now();
      const invoice = {
        id:invId,
        date:ERP.todayISO(),
        patient_id: LINKED?.patient_id || '',
        patient_name: LINKED?.name || '',
        total: totals.total,
        paid: totals.total, // full paid (demo)
      };
      const items = CART.map(l=>({ invoice_id:invId, item_name:l.name, qty:l.qty, rate:Number(l.rate??l.mrp)||0, gst:Number(l.gst||0) }));
      const allInv = ERP.load('invoices', []); allInv.push(invoice); ERP.save('invoices', allInv);
      const allItems = ERP.load('invoice_items', []); ERP.save('invoice_items', allItems.concat(items));
      alert('Saved ‚úì');
      CART=[]; renderCartTable();
    };

    // ===== PURCHASE =====
    document.getElementById('btnAddPurchase').onclick = ()=>{
      const pl = [{
        name:   document.getElementById('purName').value.trim(),
        barcode:document.getElementById('purCode').value.trim(),
        code:   document.getElementById('purCode').value.trim(),
        batch:  document.getElementById('purBatch').value.trim(),
        expiry: document.getElementById('purExpiry').value.trim(),
        qty:    Number(document.getElementById('purQty').value||0),
        mrp:    Number(document.getElementById('purMRP').value||0),
        gst:    Number(document.getElementById('purGST').value||0),
      }];
      if(!pl[0].barcode && !pl[0].name){ document.getElementById('purMsg').textContent='Need name or barcode'; return; }
      const inv = ERP.load('inventory', []);
      ERP.applyPurchaseRows(inv, pl);
      document.getElementById('purMsg').textContent='Added to stock ‚úÖ';
      // Clear qty only
      document.getElementById('purQty').value='';
    };

    // ===== STOCK =====
    function expiryState(expiry){
      if(!expiry) return 'ok';
      const d = new Date(expiry.length===7? expiry+'-01' : expiry);
      const now = new Date();
      const diff = (d - now)/86400000;
      if(diff < -1) return 'expired';
      if(diff <= 60) return 'near';
      return 'ok';
    }
    function renderStock(filter){
      const body = document.getElementById('stockBody');
      const inv = ERP.load('inventory', []);
      const q = (document.getElementById('stockSearch').value||'').toLowerCase();
      const rows = inv.filter(r=>{
        if(q && !((r.name||'').toLowerCase().includes(q) || (r.batch||'').toLowerCase().includes(q))) return false;
        const st = expiryState(r.expiry);
        if(filter==='near') return st==='near';
        if(filter==='expired') return st==='expired';
        if(filter==='low') return Number(r.qty||0) <= Number(r.min||r.min_qty||5);
        return true;
      }).map(r=>{
        const st = expiryState(r.expiry);
        const label = st==='ok' ? 'OK' : (st==='near'?'Near':'Expired');
        return `<tr>
          <td>${r.name||''}</td>
          <td>${r.batch||''}</td>
          <td>${r.expiry||''}</td>
          <td>${r.qty||0}</td>
          <td>‚Çπ ${(Number(r.mrp||0)).toFixed(2)}</td>
          <td>${label}</td>
        </tr>`;
      }).join('');
      body.innerHTML = rows || '<tr><td class="muted" colspan="6">No rows</td></tr>';
    }
    function currentFilter(){ return document.getElementById('stockFilter').value; }
    document.getElementById('stockFilter').onchange = ()=> renderStock(currentFilter());
    document.getElementById('stockSearch').oninput = ()=> renderStock(currentFilter());
    document.getElementById('btnExportStock').onclick = ()=> ERP.downloadCSV('stock_export.csv', ERP.load('inventory', []));

    // ===== REPORTS =====
    const setRange = (days)=>{ const to=new Date(), from=new Date(); from.setDate(to.getDate()-days+1); repFrom.value=from.toISOString().slice(0,10); repTo.value=to.toISOString().slice(0,10); };
    const repFrom = document.getElementById('repFrom');
    const repTo   = document.getElementById('repTo');
    document.querySelectorAll('[data-q]').forEach(b=> b.onclick=()=>{
      const q=b.dataset.q; if(q==='today') setRange(1); if(q==='7d') setRange(7); if(q==='30d') setRange(30);
      if(q==='mtd'){ const d=new Date(); repFrom.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`; repTo.value=new Date().toISOString().slice(0,10); }
      runReports();
    });
    document.getElementById('btnRunReports').onclick = runReports;
    function runReports(){
      const invsAll = ERP.load('invoices', []);
      const itemsAll = ERP.load('invoice_items', []);
      const invs = ERP.filterInvoicesByDate(invsAll, repFrom.value, repTo.value);
      const ids = new Set(invs.map(i=> i.id||i.invoice_id));
      const items = itemsAll.filter(x => ids.has(x.invoice_id));
      const k = ERP.buildSalesKPIs(invs, items);
      document.getElementById('rpTotal').textContent = k.total.toFixed(2);
      const days = Math.max(1, Math.ceil((new Date(repTo.value) - new Date(repFrom.value))/86400000) + 1);
      document.getElementById('rpAvg').textContent = (k.total/days).toFixed(2);
      document.getElementById('rpInv').textContent = String(k.invoices);
      document.getElementById('rpPaid').textContent = k.paid.toFixed(2);

      const top = ERP.topItems(items, 10);
      const body = document.getElementById('topItemsBody');
      body.innerHTML = top.length ? top.map(r=> `<tr><td>${r.name}</td><td>${r.qty}</td><td>‚Çπ ${r.amount.toFixed(2)}</td></tr>`).join('') : '<tr><td class="muted" colspan="3">‚Äî</td></tr>';
    }
    // defaults
    setRange(7); runReports();
  </script>
</body>
</html>
